<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <link rel="icon" href="./favicon.ico" type="image/x-icon">

  <!-- DOMPurify 2.4.2
     (c) 2015-2025 Cure53
     MIT License
     https://github.com/cure53/DOMPurify
-->
  <script src="https://cdn.jsdelivr.net/npm/dompurify@2.4.2/dist/purify.min.js"></script>
  <!-- MessagePack.js
     (c) 2010-2025 MessagePack project contributors
     MIT License
     https://github.com/msgpack/msgpack-javascript
-->
  <script src="https://cdn.jsdelivr.net/npm/@msgpack/msgpack/dist.es5+umd/msgpack.min.js"></script>
  <title>チャット検索(実験)</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f4f4;
      margin: 0;
      padding: 0;
    }

    h1 {
      text-align: center;
      color: #333;
      margin: 20px 0;
    }

    table {
      border-collapse: collapse;
      margin-bottom: 2rem;
      width: 100%;
    }

    th,
    td {
      border: 1px solid #ccc;
      padding: 4px 8px;
      text-align: left;
    }

    th {
      background: #f0f0f0;
    }

    td:first-child,
    th:first-child {
      white-space: nowrap;
      width: 1%;
    }

    h1 {
      font-size: 1.2rem;
      margin-top: 2rem;
    }

    .cutoff {
      color: red;
      font-weight: bold;
      margin-bottom: 2rem;
    }

    .checkboxes {
      margin-bottom: 1rem;
    }

    label {
      margin-right: 1rem;
    }

    .emoji {
      vertical-align: middle;
    }

    #back {
      position: fixed;
      top: 2px;
      left: 2px;
      z-index: 9999;
      padding: 10px 15px;
      font-size: 16px;
      border-radius: 6px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    @media (max-width: 600px) {
      #back {
        font-size: 18px;
        padding: 12px 18px;
      }
    }
  </style>
</head>

<body>
  <h1>チャット検索(実験)</h1>
  <div>ライブ動画から、キャスターに言及したチャットのみを抽出します.</div>
  <div>キャスターのミッドナイト出演を調査する為の実験的機能で、検索範囲は00:00～05:00に限定されます.</div>
  <div>指定されたワード以外の検索はできません.</div>
  <div style="margin-bottom: 20px;"></div>
  <div class="checkboxes" id="checkboxes"></div>
  <div><label><input type="checkbox" id="selectAll">All</label></div>
  <div style="margin-bottom: 20px;"></div>
  <button id="searchBtn">検索</button>
  <div style="margin-bottom: 40px;"></div>
  <div id="results"></div>
  <button id="back" onclick="location.href='./2'">戻る</button>
  <script>
    const checkboxes = [
      ["緊急", "地震", "速報", "揺れ", "登場"],
      ["山岸", "愛梨", "山岸愛梨", "あいりん"],
      ["江川", "清音", "江川清音", "さーやん"],
      ["松雪", "彩花", "松雪彩花", "あやち"],
      ["白井", "ゆかり", "白井ゆかり", "ゆかりん"],
      ["高山", "奈々", "高山奈々", "なな"],
      ["駒木", "結衣", "駒木結衣", "ゆい"],
      ["戸北", "美月", "戸北美月", "みー"],
      ["川畑", "玲", "川畑玲", "ばたやん", "きらりん"],
      ["小林", "李衣奈", "小林李衣奈", "会長", "りーちゃん"],
      ["魚住", "茉由", "魚住茉由", "まゆ"],
      ["小川", "千奈", "小川千奈", "せん"],
      ["青原", "桃香", "青原桃香", "もも"],
      ["岡本", "結子", "岡本結子リサ", "リサ", "姫"],
      ["福吉", "貴文", "福吉貴文", "ふくちゃん"],
      ["田辺", "真南葉", "田辺真南葉", "まなは", "まなっはー"],
      ["松本", "真央", "松本真央", "まお"],
      ["鈴木", "里奈", "鈴木里奈", "りなっち"],
      ["角田", "奈緒子", "角田奈緒子", "なおこーん"],
      ["武藤", "彩芽", "武藤彩芽", "横尾"],
      ["内田", "侑希", "内田侑希", "ゆっきー"],
      ["檜山", "沙耶", "檜山沙耶", "おさや", "さやっち"],
      ["眞家", "泉", "眞家泉", "いずみん"],
      ["大島", "璃音", "大島璃音", "のんちゃん"],
      ["ウェザーロイド", "Airi", "ポン子"]
    ];
    const selectAllCheckbox = document.getElementById("selectAll");
    selectAllCheckbox.addEventListener("change", (e) => {
      const isChecked = e.target.checked;
      const allCheckboxes = checkboxContainer.querySelectorAll('input[type="checkbox"]');
      allCheckboxes.forEach(cb => {
        if (cb.id !== "selectAll") {
          cb.checked = isChecked;
        }
      });
    });

    const results = document.getElementById("results");
    const checkboxContainer = document.getElementById("checkboxes");
    checkboxContainer.style.display = "grid";
    checkboxContainer.style.gridTemplateColumns = "repeat(3, 1fr)";
    checkboxContainer.style.gap = "1rem";
    checkboxes.forEach(group => {
      const groupDiv = document.createElement("div");
      groupDiv.style.padding = "0.5rem";
      groupDiv.style.border = "2px solid #666";
      groupDiv.style.cursor = "pointer";

      group.forEach(word => {
        const label = document.createElement("label");
        label.style.marginRight = "0.5rem";
        const input = document.createElement("input");
        input.type = "checkbox";
        input.value = word;
        label.appendChild(input);
        label.appendChild(document.createTextNode(word));
        groupDiv.appendChild(label);
      });
      groupDiv.addEventListener("click", (e) => {
        if (e.target.tagName.toLowerCase() === "input" || e.target.tagName.toLowerCase() === "label") return;
        const inputs = groupDiv.querySelectorAll('input[type="checkbox"]');
        const allChecked = Array.from(inputs).every(cb => cb.checked);
        inputs.forEach(cb => cb.checked = !allChecked);
      });
      checkboxContainer.appendChild(groupDiv);
    });
    document.getElementById("searchBtn").addEventListener("click", async () => {
      results.innerHTML = "";

      const selected = [...checkboxContainer.querySelectorAll("input:checked")].map(el => el.value);
      if (selected.length === 0) {
        results.textContent = "検索ワードを選んでください";
        scrollToElmName("results");
        return;
      }
      const keywords = encodeURIComponent(selected.join(","));
      const url = `https://boxpush.d4df816be9225fab.workers.dev/chat`;
      results.textContent = "読み込み中...";
      scrollToElmName("results");
      for (let attempt = 1; attempt <= 3; attempt++) {
        try {
          const response = await fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ keywords: keywords })
          });
          if (!response.ok) throw new Error(`HTTP エラー: ${response.status}`);
          results.textContent = "";
          const buffer = await response.arrayBuffer();
          const data = MessagePack.decode(new Uint8Array(buffer));
          renderResults(data);
          scrollToElmName("results");
          return
        } catch (err) {
          console.log(err)
        }
      }
      results.textContent = `エラーが発生しました`;
    });
    window.addEventListener("DOMContentLoaded", () => {
      document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
    });
    function scrollToElmName(elmName) {
      document.getElementById(elmName).scrollIntoView({ behavior: "smooth" });
    }
    function createYouTubeLink(videoId) {
      const videoUrl = `https://www.youtube.com/watch?v=${videoId}`;
      const thumbnailUrl = `https://img.youtube.com/vi/${videoId}/hqdefault.jpg`;
      const link = document.createElement("a");
      link.href = videoUrl;
      link.target = "_blank";
      link.rel = "noopener noreferrer";
      const thumbnail = document.createElement("img");
      thumbnail.src = thumbnailUrl;
      thumbnail.alt = "YouTube Video Thumbnail";
      thumbnail.style.width = "160px";
      thumbnail.style.height = "120px";
      link.appendChild(thumbnail);
      return link;
    }

    function renderResults(data) {
      const MAX_ROWS = 1000;
      let rowCount = 0;
      if (Object.keys(data).length === 0) {
        results.textContent = "検索結果は０件です";
        return;
      }
      for (let [videoId, messages] of Object.entries(data)) {
        videoId = DOMPurify.sanitize(videoId);
        const youtubeLink = createYouTubeLink(videoId);
        results.appendChild(youtubeLink);
        const table = document.createElement("table");
        const thead = document.createElement("thead");
        const headerRow = document.createElement("tr");
        const th1 = document.createElement("th");
        th1.textContent = "日時";
        headerRow.appendChild(th1);
        const th2 = document.createElement("th");
        th2.textContent = "チャット";
        headerRow.appendChild(th2);
        thead.appendChild(headerRow);
        table.appendChild(thead);

        const tbody = document.createElement("tbody");
        for (const line of messages) {
          if (rowCount >= MAX_ROWS) break;
          let [dt, msg] = line.split("\t");
          dt = DOMPurify.sanitize(dt)
          msg = sanitizeAndConvertImages(msg)
          const tr = document.createElement("tr");
          const td1 = document.createElement("td");
          td1.textContent = new Date(Number(dt) + 9 * 60 * 60 * 1000).toISOString().replace(/T/, ' ').replace(/Z/, '').replace(/-/g, '/').replace(/(\.\d{3})\d+/, '$1');
          tr.appendChild(td1);
          const td2 = document.createElement("td");
          td2.innerHTML = DOMPurify.sanitize(msg, { ALLOWED_TAGS: ['img'], ALLOWED_ATTR: ['src', 'alt', 'style', 'class'] });
          tr.appendChild(td2);
          tbody.appendChild(tr);
          rowCount++;
        }

        table.appendChild(tbody);
        results.appendChild(table);

        if (rowCount >= MAX_ROWS) {
          break;
        }
      }
      const msg = document.createElement("div");
      if (rowCount >= MAX_ROWS) {
        msg.className = "cutoff";
        msg.textContent = `表示は ${MAX_ROWS} 行で打ち切りました。`;
      } else {
        msg.className = "";
        msg.textContent = `検索結果： ${rowCount} 件`;
      }
      results.appendChild(msg);
    }

    function sanitizeAndConvertImages(input) {
      let clean = DOMPurify.sanitize(input);
      const urlPattern = /\[https:\/\/yt3\.ggpht\.com\/[^\]\s]+\]/g;
      const result = clean.replace(urlPattern, (match) => {
        const url = match.slice(1, -1);
        return `<img class="emoji" src="${url}" alt="" />`;
      });
      return result;
    }

  </script>
</body>

</html>
