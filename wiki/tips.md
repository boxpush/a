# Tips

## 限定公開の動画IDを取得する方法

### 全ての再生リストを調べる
再生リストにリンクされると限定公開であっても表示される

### ライブ中の動画の次に自動再生される動画IDを調べる
動画プレーヤーの仕様変更で次のボタンは無くなってしまったが、ショートカット(Shift+n)はまだ有効

### 投稿タブをチェックする
その日のライブ動画URLを公開しているが、費用対効果が大きいとは思えずいつまで続くか
それより番組表に自動でリンクさせた方が効率的では


## ライブ中の動画IDを取得する方法

APIは一日あたり10,000ポイントの上限が定められている
その上限を超えないように、複数の方法を組み合わせる必要がある

### RSS
https://www.youtube.com/feeds/videos.xml?channel_id=<チャンネルID>
で取得できるが、別途ライブかどうかの判定が必要

### YouTube API(v3/search)
確実だが１回のリクエストに100ポイント消費する

### YouTube API(v3/playlistItems)
別途ライブ判定が必要だが、１回のリクエストにつき１ポイントの消費

### ワンライナー
```python
python3 -c "import requests,re;print(re.search(r'タップしてライブを視聴.*?/watch\?v=([\w-]{11})',requests.get('https://www.youtube.com/weathernews/streams').text).group(1))"
```

## ライブ開始の検出方法

### YouTube API(v3/search)
事前に動画IDが判らなくてもライブ中の動画ID得する事ができる
しかし前述のとおり呼び出しコストが高いため、頻繁な呼び出しには向いていない

### YouTube API(v3/videos)
事前に動画IDが判っていれば、このAPIでライブ中かどうかの判定ができる
また同時に動画のメタデータも取得でき、その中には同時接続数も含まれる

ライブ配信ではないが指定日時に公開される動画（プレミア公開）も、ライブとして扱われる
しかしこのAPIで取得される同時接続数は常に０を返す仕様のようだ

呼び出しコストは50動画IDにつき１ポイント
例えば動画IDがn本だとすると、１回の呼び出しに消費するポイントpは
$$
p = \left[ \frac{n-1}{50} \right] + 1
$$

このAPIをx秒に１回呼び出すと仮定すると、
$$
１日の消費ポイント = \frac{86400}{x} \cdot \left( \left[ \frac{n-1}{50} \right] + 1 \right)
$$

## ライブの開始を検知できない問題

### 限定公開で動画登録され、限定公開のままライブを開始する
稀によくある
事前に動画IDを知らない限り、検知する術がない

### 公開設定で動画登録され、長い期間の後に限定公開でライブを開始する

限定公開であっても、動画IDが判っていればv3/videosによりライブ開始の検知は可能
しかしコストの兼ね合いで一度に大量の動画IDをチェックするのは難しい
配信予定の動画が余りに多くなると、古い時期に登録された動画のチェックは諦めざるを得なくなる

配信予定日時が近づいた動画IDに絞り込む事で取りこぼし対策にはなるものの
予定日時どおりに配信されるとは限らないので完璧ではない

## チャンネル配下の全動画IDを調べる方法

### ブラウザを使って調査
１ページに表示される動画数が５千本あたりでブラウザがクラッシュする
新しい動画順と古い動画順で５千本ずつなので結局１万本あたりが上限となる
Seleniumなどヘッドレスブラウザを使っても、やはり本数が多いとクラッシュする

### YouTube API(v3/playlistItems)
取得上限は２万本
そこまで動画を抱えてるチャンネルは国内で数十程度だが、WNLはそれに該当する
故に全動画を調べる事は不可能

### Pythonライブラリ
具体名は挙げないが、スクレイピングとか非公開APIを叩くとかやってるらしい

### JSONデータから取得
YouTubeのページソースからJSON形式のデータを抽出することで、動画情報を取得できる場合がある
この方法はブラウザを起動しないのでブラウザクラッシュの心配がない
